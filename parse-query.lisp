
(in-package #:cl-arxiv-api)

(cl-interpol:enable-interpol-syntax)

;;; Here we will parse response of arXiv, which is in Atom 1.0 format

(defun %parse-arxiv-response (str)
  (parse str (cxml-xmls:make-xmls-builder)))

(defun parse-arxiv-response (str)
  (try-to-descend (%parse-arxiv-response str)))

(define-condition arxiv-parse-error (error simple-condition) ())
(defmacro fail-parse ()
  `(error 'arxiv-parse-error))

(eval-when (:compile-toplevel :load-toplevel :execute)
  (defparameter *parsers* (make-hash-table :test #'equal))
  (defparameter *default-namespace* :atom)
  (defparameter *namespace-map* '((:atom . "http://www.w3.org/2005/Atom")
				  (:opensearch . "http://a9.com/-/spec/opensearch/1.1/")
				  (:arxiv . "http://arxiv.org/schemas/atom")))
  (defun subcamcaseize (name)
    (let ((lst (cl-ppcre:split "-" (string-downcase name))))
      (format nil "狺ㄣ镱ㄣ狎祗舂磲疸狎＇篝蜷铉汜痖翎扉ㄣ潋祗舂┅┅ㄤ彐躅孱篚蝈钺礤箴徙瀛骝邋翳轭绌ㄩㄡ麸翳轭绌翳轭ㄣ狎翳轭绌┅ㄤ彐躅躅溴蝮翎钿箴邈箴邈ㄤ弩趄蹉趱蜷铉忾钿钺礤箴徙濠ㄩ铒ㄡ麸箴邈┅扉篝ㄣ狎箴邈ㄣ潋ㄡ篌镢ㄣ徜箴邈钺礤箴徙瀛磲皙┅扉篝箴邈ㄣ潋ㄡ篌镢溴驷蹯舡钺礤箴徙濯钺礤箴徙瀛磲皙┅┅鲠祯弩ㄣ镱è篝蜷铉钺礤钺礤è簌礅镬钺礤篚忏犴汜箦辁钺礤┅ㄥ蝌矧⒛镱腩秣栾麸泔弪沐翳轶麸犷赝殇孱糸骈弪幄钺礤┅ㄣ镱è篝蜷铉钺礤ㄩ铘弪ㄣ飙痧泸搴蝈珏蝈痨徙瀛犰⑦篝蜷铉躔汜箦钺礤⑺刨紫夷┅è簌礅镬钺礤ㄩ铘弪篝蜷铉钺礤⑺刨紫夷┅ㄥ蝌矧⒛镱腩秣栾麸泔弪沐翳轶麸脲黠蜾幄钺礤┅箴徙濠┅ㄤ彐躅屙痿扉铄箜翳ㄡ钿篝蜷铉箜翳ㄣ飙痧泸搴犰飙磲翥桢蟓狍篝蜷铉⑥ㄜ茴苘簏苘酎苘颟あ箜翳舂换ㄤ彐躅ャ狎羼麸麒狒箜翳换ㄡ钿ㄣ镱箴箜翳换戾è轸ㄣ狎箜翳┅换ㄤ弩趄蹉趱蜷铉忾钿麸麒狒汜麸麒狒沅颟麸麒狒换ㄨ犷潇弪汜箦ㄤ弩趄蹉趱蜷铉忾钿ㄩ舡汜轸沅颟轸换┅┅┅换ㄤ彐磲泸汜颦羼é蝈篝麸麒狒换啜ャ狎羼К麸麒狒屐舂ㄤ彐磲泸溴骈铄疳蝮弪翳轭怙澌怙澌眭祠轲戾鲠祯瀛忾钿篝颦钺礤膑洵钺礤钺礤箴徙濠躅溴蝮翎钿箴邈翳轭绌啜箦翩ㄧ弭栳箬ㄣ镱篝颦钺礤钺礤箴徙濠疳蝮弪螵灬礅溽ㄩ舂戾è膑膑洵钺礤┅ㄤ邈灬蝈ㄩ珙矧徕戾膑洎棱镤┅┅ㄤ彐磲泸溴骈铄溴驷蹯舡疳蝮弪翳轭绌啜溴骈铄疳蝮弪翳轭ㄣ镱膑ㄣ徜潋轸┅┅ㄤ彐磲泸溴骈铄溴驷蹯舡疳蝮弪骘é蝈篝翳轭珞啜痱镧括磲疸狎灬礅溽啜溴骈铄溴驷蹯舡疳蝮弪┅翳轭珞┅ㄤ彐轭瀛溴驷蹯舡疳蝮弪骘呼轸戾洪乎痄狒邃吼踱扉箬邃后蹴磲蝙侯犴ê泔眄孱横蝤轹ê滹横蝤轹┅ㄤ彐躅趄麸溴筱孱箜翳ㄩ铒ㄣ镱箴箜翳┅ㄦ衢飙疳蝮濠戾è疳蝮弪ㄧ弭栳箬ㄣ狎箜翳疳蝮弪螵┅ㄩ铒疳蝮弪ㄦ衢飙疳蝮濠ㄦ躅汜祆疳蝮弪箜翳┅┅ㄤ彐躅疳蝮瀛狍扉篝箜翳ㄩ翦ㄦ矧屐轭箜翳换ㄦ矧磲狺ア屐舂麒孱铒ㄥ眇豉扉铄屐舂ㄨ犷潇弪汜箦ㄣ镬戾泗趄麸溴筱孱屐舂ㄡ蝤轹疳蝮瀛弪蝻ī麽蝾⑵衢戾麸疳蝮蟋泔祆邈糸铉鲥蜮狒轫屐舂ㄣ镬戾泗屐舂┅┅ㄤ彐轭瀛疳蝮弪烘邋疳蝮瀛狍扉篝ㄣ滗轸┅ㄤ彐轭瀛疳蝮弪哄铘蝙ㄣ镱哄铘蝙疳蝮瀛狍扉篝ㄣ滗轸┅┅ㄤ彐轭瀛疳蝮弪红轭戾è轸疳蝮瀛狍扉篝ㄣ徜轸┅┅戾è钺礤ㄣ狎矧ㄣ潋ㄡ篌镢Ⅱ屐轸呼弩＇羼踽飑ㄣ潋ㄡ篌镢Ⅳ轸戾轸呼弩＇羼踽飑ㄦ衢飙疳蝮濠┅ㄨ蝈ㄣ狎矧ㄣ潋ㄡ篌镢㈣蝈姊轸呼弩＇羼踽飑ㄦ衢飙疳蝮濠┅┅ㄣ镱ㄩ铘弪？え篝蜷铉躔汜箦钺礤┅躺嗡⑺刨紫夷栩彐┅┅ㄤ彐磲泸溴骈铄轭翦珏颦疳蝮弪翳轭绌啜溴骈铄疳蝮弪翳轭ㄣ镱膑疳蝮瀛轭翦珏ㄣ徜潋轸┅┅ㄤ彐磲泸溴骈铄轭翦珏颦疳蝮弪骘é蝈篝翳轭珞啜痱镧括磲疸狎灬礅溽啜溴骈铄轭翦珏颦疳蝮弪┅翳轭珞┅ㄤ彐轭瀛轭翦珏颦疳蝮弪骘ê麸翎飙蝈篚祠猴疱铙遽蜚瑭ê篝狎舡轭溴猴疱铙遽蜚瑭ê轸屙蟓疱颦疳珏猴疱铙遽蜚瑭ㄤ彐轭瀛疳蝮弪横豸栾戾è轸ㄣ潋ㄡ篌镢侯犴疳蝮瀛狍扉篝ㄣ滗轸┅┅┅ㄩ铒轸ㄦ衢飙疳蝮濠ㄣ镱膑轸┅┅ㄤ彐轭瀛疳蝮弪恒狒彗矧戾è轸ㄣ徜ㄡ篌镢Ⅳ弪恝疳蝮瀛狍扉篝ㄣ徜轸┅呼弩＇羼踽飑┅ㄩ铒轸ㄦ衢飙疳蝮濠ㄣ镱膑轸┅┅ㄤ彐轭瀛疳蝮弪á痱轫狎咩狒彗矧横蝤轹戾è轸ㄣ徜ㄡ篌镢Ⅳ弪恝疳蝮瀛狍扉篝ㄣ徜轸┅呼弩＇羼踽飑┅ㄩ铒轸ㄦ衢飙疳蝮濠ㄣ镱吼蜷磲蝙汜翦顼蝙轸┅┅ㄤ彐轭瀛疳蝮弪á觑躜钺爝蝈姊横蝤轹ㄣ镱宏秕蝾犰蝈ㄣ徜潋轸┅ㄤ彐躅栳箬踞篌镢ㄨ狍瑭ㄩ翦ㄦ矧脲鲠飑轭栳箬翎忪栳箬ㄣ镬戾泗ㄣ镱脲鲠飑┅换ㄤ彐躅箝眇扉纟狎轹蝈箴镱箦祗舂换蝈盹鲥殒铒＇殇孱糸豉换ㄩ翦ㄦ矧屐轭祗舂换ㄣ镬戾泗ㄩㄥ眇豉扉铄屐舂换铋换麸瓠滹黝疳蝮ㄥ祠轰彐狨祠钺礤箴徙横麸愆换ê扉铍啜红轭换ê孱趄箝眇扉纟蝈箴镱箦孱趄换┅┅┅